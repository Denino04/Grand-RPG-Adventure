<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text RPG Adventure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a; /* Dark background for the whole page */
        }
        .font-medieval {
            font-family: 'MedievalSharp', cursive;
        }
        /* Custom scrollbar for a better look */
        #game-log::-webkit-scrollbar {
            width: 8px;
        }
        #game-log::-webkit-scrollbar-track {
            background: #2d3748;
        }
        #game-log::-webkit-scrollbar-thumb {
            background-color: #718096;
            border-radius: 4px;
        }
        .btn {
            @apply px-4 py-2 rounded-lg font-semibold text-white transition-all duration-200 shadow-md;
        }
        .btn:disabled {
            @apply bg-gray-500 border-gray-700 cursor-not-allowed;
        }
        .btn-primary {
            @apply bg-slate-600 hover:bg-slate-500 border-b-4 border-slate-800 hover:border-slate-700;
        }
        .btn-action {
            @apply bg-red-700 hover:bg-red-600 border-b-4 border-red-900 hover:border-red-800;
        }
        .btn-magic {
            @apply bg-purple-700 hover:bg-purple-600 border-b-4 border-purple-900 hover:border-purple-800;
        }
        .btn-item {
             @apply bg-green-700 hover:bg-green-600 border-b-4 border-green-900 hover:border-green-800;
        }
        /* Stylized scrollbar for inventory */
        .inventory-scrollbar::-webkit-scrollbar {
            width: 10px;
        }
        .inventory-scrollbar::-webkit-scrollbar-track {
            background: #1a202c; /* A darker gray */
            border-radius: 5px;
        }
        .inventory-scrollbar::-webkit-scrollbar-thumb {
            background-color: #a0aec0; /* A lighter gray */
            border-radius: 5px;
            border: 2px solid #1a202c; /* Padding around thumb */
        }
        .inventory-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #cbd5e0; /* Even lighter on hover */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen p-4">

    <!-- Start Screen -->
    <div id="start-screen" class="text-center">
        <h1 class="font-medieval text-6xl text-yellow-400 mb-4">Chronicles of the Void</h1>
        <p class="mb-8 text-lg text-gray-400">Enter your hero's name to begin your journey.</p>
        <input type="text" id="player-name-input" class="bg-gray-800 border border-gray-600 text-white text-center text-lg rounded-lg px-4 py-2 mb-4 w-64 focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="e.g., Eldrin">
        <button id="start-game-btn" class="btn btn-primary text-xl px-8 py-3">Begin Adventure</button>
        <button id="load-game-btn" class="btn btn-primary text-xl px-8 py-3 mt-4 hidden">Load Saved Game</button>
    </div>

    <!-- Main Game Container -->
    <div id="game-container" class="relative w-full max-w-4xl mx-auto bg-gray-800 rounded-2xl shadow-2xl border border-gray-700 p-6 hidden">
        
        <button onclick="exitGame()" title="Save and Exit" class="absolute top-2 right-2 w-8 h-8 flex items-center justify-center bg-slate-700 hover:bg-red-600 rounded-full transition-colors duration-200">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
        
        <div id="stats-view" class="mb-4 p-4 bg-slate-900 rounded-lg grid grid-cols-1 lg:grid-cols-3 gap-x-6 gap-y-4 text-sm">
            <div class="lg:col-span-2 space-y-2">
                 <div class="flex justify-between items-start">
                    <div>
                        <p id="player-name" class="font-bold text-yellow-400 text-lg">Player</p>
                        <p>Level: <span id="player-level">1</span> | Gold: <span id="player-gold">100</span> G</p>
                        <p class="mt-2">XP: <span id="player-xp-text">0 / 100</span></p>
                    </div>
                    <div class="text-right font-semibold">
                        <p class="text-red-400">HP: <span id="player-hp-text">50 / 50</span></p>
                        <p class="text-blue-400">MP: <span id="player-mp-text">20 / 20</span></p>
                    </div>
                 </div>
                 <div id="quest-tracker" class="text-xs text-amber-300 h-4 mt-1"></div>
            </div>
            <div class="bg-slate-800 p-3 rounded-lg lg:col-span-1">
                 <div class="flex justify-center items-center mb-2">
                     <h3 class="font-bold text-yellow-400 text-center">Equipment</h3>
                     <button onclick="renderInventory()" title="Open Inventory" class="ml-4 p-1 bg-slate-700 hover:bg-slate-600 rounded-full transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                        </svg>
                     </button>
                 </div>
                 <div id="equipment-display" class="text-xs space-y-1">
                    <p>Weapon: <span id="equipped-weapon"></span></p>
                    <p>Armor: <span id="equipped-armor"></span></p>
                    <p>Shield: <span id="equipped-shield"></span></p>
                    <p>Lure: <span id="equipped-lure"></span></p>
                 </div>
            </div>
        </div>

        <div id="main-view" class="min-h-[250px] bg-slate-900/50 p-6 rounded-lg mb-4 flex flex-col justify-center items-center">
            <!-- Game content is dynamically inserted here -->
        </div>

        <div class="bg-black/30 rounded-lg p-4 h-48 overflow-y-auto" id="game-log">
            <!-- Log messages are added here -->
        </div>
    </div>

    <!-- UI TEMPLATES -->
    <div id="game-templates" class="hidden">
        
        <template id="template-main-menu">
            <h2 class="font-medieval text-3xl mb-4 text-center">What would you like to do?</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="startBattle()" class="btn btn-primary">Enter the Wilderness</button>
                <button onclick="renderTown()" class="btn btn-primary">Go to Town</button>
                <button onclick="saveGame(true)" class="btn btn-primary">Save Game</button>
            </div>
        </template>

        <template id="template-town">
            <h2 class="font-medieval text-3xl mb-4 text-center">You are in town.</h2>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="renderShop('store')" class="btn btn-primary w-full">General Store</button>
                <button onclick="renderShop('blacksmith')" class="btn btn-primary w-full">Blacksmith</button>
                <button onclick="renderMagicShop()" class="btn btn-primary w-full">Magic Shop</button>
                <button onclick="renderQuestBoard()" class="btn btn-primary w-full">Quest Board</button>
                <button onclick="renderInn()" class="btn btn-primary w-full">The Inn</button>
                <button onclick="renderMainMenu()" class="btn btn-primary col-span-2">Leave Town</button>
            </div>
        </template>
        
        <template id="template-battle">
            <div class="w-full text-center">
                <h2 class="font-medieval text-4xl mb-2 text-red-400" data-id="enemy-name">Enemy Name</h2>
                <p class="mb-4" data-id="enemy-hp">HP / MaxHP</p>
                <div id="battle-actions" class="flex justify-center gap-4 mt-8">
                    <button onclick="battleAction('attack')" class="btn btn-action w-32">Attack</button>
                    <button onclick="battleAction('magic')" class="btn btn-magic w-32">Magic</button>
                    <button onclick="battleAction('item')" class="btn btn-item w-32">Item</button>
                    <button onclick="battleAction('flee')" class="btn btn-primary w-32">Flee</button>
                </div>
            </div>
        </template>
        
        <template id="template-death">
             <h1 class="font-medieval text-6xl text-red-600 animate-pulse">You Have Died</h1>
        </template>

    </div>

<script src="game_data.js"></script>
<script>
// --- GAME STATE & CLASSES -------------------------------------------------------
let player;
let currentEnemy;
let gameState = { currentView: 'main_menu', isPlayerTurn: true };
let lastViewBeforeInventory = 'main_menu';

// --- UTILITY FUNCTIONS ---
const $ = (selector) => document.querySelector(selector);
const logElement = $('#game-log');
const mainView = $('#main-view');

function rollDice(numDice, sides) { let total = 0; for (let i = 0; i < numDice; i++) { total += Math.floor(Math.random() * sides) + 1; } return total; }
function addToLog(message, color = 'text-gray-300') { const p = document.createElement('p'); p.innerHTML = message; p.className = `mb-1 ${color}`; logElement.appendChild(p); logElement.scrollTop = logElement.scrollHeight; }
function getItemDetails(itemKey) { if (itemKey in ITEMS) return ITEMS[itemKey]; if (itemKey in WEAPONS) return WEAPONS[itemKey]; if (itemKey in ARMOR) return ARMOR[itemKey]; if (itemKey in SHIELDS) return SHIELDS[itemKey]; if (itemKey in LURES) return LURES[itemKey]; return null; }
function render(viewElement) { mainView.innerHTML = ''; mainView.appendChild(viewElement); }

// --- CLASSES ---
class Entity {
    constructor(name, hp, strength) { this.name = name; this.maxHp = hp; this.hp = hp; this.strength = strength; }
    isAlive() { return this.hp > 0; }
}

class Player extends Entity {
    constructor(name) {
        super(name, 50, 5);
        this.gold = 100; this.level = 1; this.xp = 0; this.xpToNextLevel = 100;
        this.mp = 20; this.maxMp = 20; this.intelligence = 5;
        this.equippedWeapon = WEAPONS['rusty_sword'];
        this.equippedArmor = ARMOR['rags'];
        this.equippedShield = SHIELDS['no_shield'];
        this.equippedLure = LURES['no_lure'];
        this.inventory = { 
            items: { 'health_potion': 2 }, 
            weapons: ['rusty_sword'], 
            armor: ['rags'], 
            shields: ['no_shield'], 
            lures: ['no_lure'],
            lureUses: {} 
        };
        this.spells = ['fireball', 'heal'];
        this.activeQuest = null; this.questProgress = 0;
    }
    addToInventory(itemKey, quantity = 1, verbose = true) {
        const details = getItemDetails(itemKey); if (!details) return;
        if (verbose) addToLog(`You received: <span class="font-bold text-yellow-300">${details.name}</span>!`, 'text-green-400');
        
        const category = itemKey in WEAPONS ? 'weapons' : 
                         (itemKey in ARMOR ? 'armor' : 
                         (itemKey in SHIELDS ? 'shields' : 
                         (itemKey in LURES ? 'lures' : 'items')));

        if (category === 'items') { 
            this.inventory.items[itemKey] = (this.inventory.items[itemKey] || 0) + quantity; 
        } else { 
            if (!this.inventory[category].includes(itemKey)) { 
                this.inventory[category].push(itemKey); 
            } 
            if (category === 'lures' && details.uses) {
                // When buying or finding a lure, set its uses.
                this.inventory.lureUses[itemKey] = details.uses;
            }
        }
    }
    gainXp(amount) { this.xp += amount; addToLog(`You gained <span class="font-bold">${amount}</span> XP!`, 'text-yellow-400'); if (this.xp >= this.xpToNextLevel) this.levelUp(); updateStatsView(); }
    levelUp() { this.level++; this.xp -= this.xpToNextLevel; this.xpToNextLevel = Math.floor(this.xpToNextLevel * 1.5); this.maxHp += 10; this.hp = this.maxHp; this.maxMp += 5; this.mp = this.maxMp; this.strength += 2; this.intelligence += 2; addToLog(`*** LEVEL UP! You are now level ${this.level}! ***`, 'text-yellow-200 font-bold text-lg'); }
    takeDamage(damage) { 
        if (this.equippedShield && Math.random() < this.equippedShield.blockChance) {
            addToLog(`You blocked the attack with your ${this.equippedShield.name}!`, 'text-cyan-400 font-bold');
            updateStatsView();
            return;
        }
        const totalDefense = this.equippedArmor.defense + (this.equippedShield ? this.equippedShield.defense : 0);
        const finalDamage = Math.max(0, damage - totalDefense); 
        this.hp -= finalDamage; 
        addToLog(`You take <span class="font-bold text-red-400">${finalDamage}</span> damage.`); 
        updateStatsView(); 
    }
}

class Enemy extends Entity {
     constructor(speciesData, rarityData, playerLevel) {
        const multiplier = rarityData.multiplier + (playerLevel * 0.1);
        super(`${rarityData.name} ${speciesData.name}`, Math.floor(speciesData.base_hp * multiplier), Math.floor(speciesData.base_strength * multiplier));
        this.damage = rarityData.damage; this.ability = rarityData.ability;
        this.xpReward = Math.floor(speciesData.base_xp * multiplier); this.goldReward = Math.floor(speciesData.base_gold * multiplier);
        this.lootTable = speciesData.loot_table; this.lootChanceMod = rarityData.loot_chance_mod; this.speciesData = speciesData;
    }
    attack(target) {
        addToLog(`${this.name} attacks ${target.name}!`); this._performAttack(target);
        if (this.ability === 'double_strike' && Math.random() < 0.33) { addToLog(`${this.name}'s fury lets it attack again!`, 'text-red-500 font-bold'); setTimeout(() => this._performAttack(target), 500); }
    }
    _performAttack(target) {
        const totalDamage = rollDice(...this.damage) + this.strength; target.takeDamage(totalDamage);
        if (this.ability === 'life_drain') { const drainAmount = Math.floor(totalDamage / 2); this.hp = Math.min(this.maxHp, this.hp + drainAmount); addToLog(`${this.name} drains <span class="font-bold text-green-400">${drainAmount}</span> HP!`); }
    }
    takeDamage(damage) { 
        this.hp -= damage;
        if (gameState.currentView === 'battle') {
            renderBattle();
        }
    }
}

function generateEnemy() {
    // Lure Logic
    const lure = player.equippedLure;
    const lureKey = Object.keys(LURES).find(key => LURES[key] === lure);
    let speciesKey;

    if (lureKey && lure.lureTarget && Math.random() < 0.6) { // 60% chance for lure to work
        speciesKey = lure.lureTarget;
        addToLog(`Your ${lure.name} attracts a creature!`, 'text-purple-300');
        
        // Consume a use
        player.inventory.lureUses[lureKey]--;
        const remainingUses = player.inventory.lureUses[lureKey];
        if (remainingUses <= 0) {
            addToLog(`Your ${lure.name} has expired and crumbled to dust!`, 'text-red-400 font-bold');
            player.inventory.lures = player.inventory.lures.filter(key => key !== lureKey);
            delete player.inventory.lureUses[lureKey];
            player.equippedLure = LURES['no_lure'];
        } else {
            addToLog(`It has ${remainingUses} uses left.`);
        }
        updateStatsView();

    } else {
        const monsterKeys = Object.keys(MONSTER_SPECIES);
        speciesKey = monsterKeys[Math.floor(Math.random() * monsterKeys.length)];
    }

    // Level-Scaled Rarity Logic
    const rarityKeys = Object.keys(MONSTER_RARITY);
    let weights = [60, 25, 10, 4, 1]; // Base weights
    const levelModifier = Math.floor(player.level / 2);
    weights[0] = Math.max(10, 60 - levelModifier * 4); 
    weights[1] = Math.max(15, 25 - levelModifier * 2);
    weights[2] += levelModifier * 2; 
    weights[3] += levelModifier * 1.5;
    weights[4] += levelModifier * 1;  

    const chosenRarityKey = choices(rarityKeys, weights);
    currentEnemy = new Enemy(MONSTER_SPECIES[speciesKey], MONSTER_RARITY[chosenRarityKey], player.level);
}

function choices(population, weights) { 
    let totalWeight = weights.reduce((acc, w) => acc + w, 0); 
    let randomNum = Math.random() * totalWeight; 
    for (let i = 0; i < population.length; i++) { 
        if (randomNum < weights[i]) return population[i]; 
        randomNum -= weights[i]; 
    } 
}

// --- UI RENDERING FUNCTIONS ----------------------------------------------------
function updateStatsView() {
    if (!player) return;
    $('#player-name').textContent = player.name; $('#player-level').textContent = player.level; $('#player-gold').textContent = player.gold;
    $('#player-hp-text').textContent = `${player.hp} / ${player.maxHp}`; $('#player-mp-text').textContent = `${player.mp} / ${player.maxMp}`; $('#player-xp-text').textContent = `${player.xp} / ${player.xpToNextLevel}`;
    const weapon = player.equippedWeapon; 
    const armor = player.equippedArmor;
    const shield = player.equippedShield;
    const lure = player.equippedLure;
    $('#equipped-weapon').textContent = `${weapon.name} (${weapon.damage[0]}d${weapon.damage[1]})`; 
    $('#equipped-armor').textContent = `${armor.name} (Def: ${armor.defense})`;
    $('#equipped-shield').textContent = `${shield.name} (Def: ${shield.defense}, Block: ${Math.round(shield.blockChance * 100)}%)`;
    $('#equipped-lure').textContent = lure.name;
    const questTrackerEl = $('#quest-tracker');
    if (player.activeQuest) {
        const quest = QUESTS[player.activeQuest]; let progress = player.questProgress;
        if (quest.type === 'fetch') { progress = player.inventory.items[quest.target] || 0; }
        questTrackerEl.innerHTML = `<strong>Quest:</strong> ${quest.title} (${progress} / ${quest.required})`;
    } else { questTrackerEl.innerHTML = ''; }
}

function returnFromInventory() {
    switch (lastViewBeforeInventory) {
        case 'main_menu': renderMainMenu(); break;
        case 'town': renderTown(); break;
        case 'quest_board': renderQuestBoard(); break;
        case 'inn': renderInn(); break;
        case 'magic_shop': renderMagicShop(); break;
        case 'shop': renderShop('store'); break;
        case 'blacksmith': renderShop('blacksmith'); break;
        case 'sell': renderSell(); break;
        case 'battle': renderBattle('main'); break;
        default: renderMainMenu();
    }
}

function renderMainMenu() {
    lastViewBeforeInventory = 'main_menu';
    gameState.currentView = 'main_menu';
    saveGame();
    const template = document.getElementById('template-main-menu');
    render(template.content.cloneNode(true));
}

function exitGame() {
    addToLog('Saving your progress...');
    saveGame();
    setTimeout(() => {
        $('#game-container').classList.add('hidden');
        $('#start-screen').classList.remove('hidden');
        logElement.innerHTML = ''; // Clear the log for the next session
        $('#load-game-btn').classList.remove('hidden'); // Ensure load button is visible
    }, 1000);
}

function renderTown() {
    lastViewBeforeInventory = 'town';
    gameState.currentView = 'town';
    const template = document.getElementById('template-town');
    render(template.content.cloneNode(true));
}

function renderQuestBoard() {
    lastViewBeforeInventory = 'quest_board';
    gameState.currentView = 'quest_board'; 
    let html = `<div class="w-full"><h2 class="font-medieval text-3xl mb-4 text-center">Quest Board</h2>`;
    if (player.activeQuest) {
        const quest = QUESTS[player.activeQuest]; let progress = player.questProgress;
        if (quest.type === 'fetch') { progress = player.inventory.items[quest.target] || 0; }
        html += `<div class="p-4 bg-slate-800 rounded-lg text-center"><h3 class="font-bold text-yellow-300">${quest.title} (Active)</h3><p class="text-gray-400 my-2">${quest.description}</p><p>Progress: ${progress} / ${quest.required}</p><p>Reward: ${quest.reward.xp} XP, ${quest.reward.gold} G</p><button onclick="completeQuest()" class="btn btn-primary mt-4" ${progress < quest.required ? 'disabled' : ''}>Complete Quest</button></div>`;
    } else {
        html += `<p class="text-center mb-4">Pick a quest to undertake.</p>`;
        const availableQuests = Object.keys(QUESTS); const offeredQuests = availableQuests.sort(() => 0.5 - Math.random()).slice(0, 3);
        html += `<div class="h-80 overflow-y-auto inventory-scrollbar pr-2 space-y-3">`
        html += offeredQuests.map(key => { const quest = QUESTS[key]; return `<div class="p-3 bg-slate-800 rounded-lg"><h3 class="font-bold text-yellow-300">${quest.title}</h3><p class="text-sm text-gray-400 my-1">${quest.description}</p><p class="text-sm">Reward: ${quest.reward.xp} XP, ${quest.reward.gold} G</p><button onclick="acceptQuest('${key}')" class="btn btn-primary mt-2 text-sm py-1 px-3">Accept</button></div>`; }).join('');
        html += `</div>`;
    }
    html += `<div class="text-center mt-4"><button onclick="renderTown()" class="btn btn-primary">Back to Town</button></div></div>`; 
    const container = document.createElement('div');
    container.innerHTML = html;
    render(container);
}

function acceptQuest(questKey) { if (!player.activeQuest) { player.activeQuest = questKey; player.questProgress = 0; addToLog(`New quest accepted: <span class="font-bold text-yellow-300">${QUESTS[questKey].title}</span>!`); updateStatsView(); renderQuestBoard(); } else { addToLog(`You already have an active quest!`); } }
function completeQuest() {
    if (!player.activeQuest) return; const quest = QUESTS[player.activeQuest];
    if (quest.type === 'fetch') { player.inventory.items[quest.target] -= quest.required; if (player.inventory.items[quest.target] <= 0) { delete player.inventory.items[quest.target]; } }
    addToLog(`Quest Complete: <span class="font-bold text-green-400">${quest.title}</span>!`);
    player.gainXp(quest.reward.xp); player.gold += quest.reward.gold; addToLog(`You received ${quest.reward.gold} G.`, 'text-yellow-400');
    player.activeQuest = null; player.questProgress = 0; updateStatsView(); renderQuestBoard();
}

function renderInn() { 
    lastViewBeforeInventory = 'inn';
    gameState.currentView = 'inn'; 
    const cost = 10 * player.level; 
    let html = `<h2 class="font-medieval text-3xl mb-4 text-center">The Weary Traveler Inn</h2><p class="mb-4 text-center">A night's rest costs ${cost} G. You will be fully restored.</p><div class="flex justify-center gap-4"><button onclick="restAtInn(${cost})" class="btn btn-primary" ${player.gold < cost ? 'disabled' : ''}>Rest for the night</button><button onclick="renderTown()" class="btn btn-primary">Leave</button></div>${player.gold < cost ? '<p class="text-red-400 mt-2 text-center">You cannot afford a room.</p>' : ''}`;
    const container = document.createElement('div');
    container.innerHTML = html;
    render(container);
}
function restAtInn(cost) { player.gold -= cost; addToLog(`You pay <span class="font-bold">${cost} G</span> for a room.`, 'text-yellow-400'); if (Math.random() < 0.1) { addToLog(`You are ambushed in your sleep!`, 'text-red-500 font-bold'); setTimeout(startBattle, 2000); } else { player.hp = player.maxHp; player.mp = player.maxMp; addToLog(`You wake up feeling refreshed.`, 'text-green-400 font-bold'); updateStatsView(); setTimeout(renderTown, 2000); } }

function renderMagicShop() { 
    lastViewBeforeInventory = 'magic_shop';
    gameState.currentView = 'magic_shop'; 
    let learnableSpells = Object.keys(MAGIC).filter(key => !player.spells.includes(key)); 
    let spellsHtml = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
    spellsHtml += learnableSpells.map(key => { const details = MAGIC[key]; return `<div class="p-3 bg-slate-800 rounded"><div class="flex justify-between items-center"><h3 class="font-medieval text-lg text-purple-300">${details.name}</h3><div><span class="text-yellow-400 font-semibold mr-4">${details.price} G</span><button onclick="learnSpell('${key}')" class="btn btn-magic text-sm py-1 px-3" ${player.gold < details.price ? 'disabled' : ''}>Learn</button></div></div><p class="text-sm text-gray-400 mt-1">${details.description}</p></div>`; }).join(''); 
    spellsHtml += '</div>';
    if (learnableSpells.length === 0) { spellsHtml = `<p class="text-center text-gray-400">You have learned all available spells.</p>`; } 
    let html = `<div class="w-full"><h2 class="font-medieval text-3xl mb-4 text-center">Whispering Grimoire</h2><p class="text-center text-gray-400 mb-4">Learn new spells to aid you in your journey.</p><div class="h-80 overflow-y-auto inventory-scrollbar pr-2">${spellsHtml}</div><div class="flex justify-center gap-4 mt-4"><button onclick="renderTown()" class="btn btn-primary">Back to Town</button></div></div>`;
    const container = document.createElement('div');
    container.innerHTML = html;
    render(container);
}
function learnSpell(spellKey) { const details = MAGIC[spellKey]; if (player.gold >= details.price) { player.gold -= details.price; player.spells.push(spellKey); addToLog(`You have learned the spell: <span class="font-bold text-purple-300">${details.name}</span>!`, 'text-green-400'); updateStatsView(); renderMagicShop(); } }

function renderShop(type) {
    lastViewBeforeInventory = type === 'store' ? 'shop' : 'blacksmith';
    gameState.currentView = type === 'store' ? 'shop' : 'blacksmith';
    const inventory = type === 'store' ? SHOP_INVENTORY : BLACKSMITH_INVENTORY;
    const title = type === 'store' ? 'General Store' : 'Clanging Hammer Blacksmith';
    let itemsHtml = '';
    for (const category in inventory) {
        itemsHtml += `<h3 class="font-medieval text-xl mt-4 mb-2 text-yellow-300">${category}</h3>`;
        itemsHtml += '<div class="space-y-2">';
        itemsHtml += inventory[category].map(key => {
            const details = getItemDetails(key);
            if (!details) return '';
            return `<div class="flex justify-between items-center p-2 bg-slate-800 rounded"><span>${details.name}</span><div><span class="text-yellow-400 font-semibold mr-4">${details.price} G</span><button onclick="buyItem('${key}')" class="btn btn-primary text-sm py-1 px-3" ${player.gold < details.price ? 'disabled' : ''}>Buy</button></div></div>`;
        }).join('');
        itemsHtml += '</div>';
    }
    let html = `<div class="w-full"><h2 class="font-medieval text-3xl mb-4 text-center">${title}</h2><div class="h-80 overflow-y-auto inventory-scrollbar pr-2">${itemsHtml}</div><div class="flex justify-center gap-4 mt-4">${type === 'store' ? `<button onclick="renderSell()" class="btn btn-primary">Sell Items</button>` : ''}<button onclick="renderTown()" class="btn btn-primary">Back to Town</button></div></div>`;
    const container = document.createElement('div');
    container.innerHTML = html;
    render(container);
}

function buyItem(itemKey) { const details = getItemDetails(itemKey); if (player.gold >= details.price) { player.gold -= details.price; player.addToInventory(itemKey, 1, false); addToLog(`You bought a ${details.name} for ${details.price} G.`, 'text-yellow-400'); updateStatsView(); renderShop(gameState.currentView); } }
function renderSell() { 
    lastViewBeforeInventory = 'sell';
    gameState.currentView = 'sell'; 
    let sellableHtml = ''; 
    const itemMap = {}; 
    let itemIndex = 0; 
    for (const category in player.inventory) { if (category === 'items' || category === 'lures') { for (const key in player.inventory[category]) { const details = getItemDetails(key); if (details && details.price > 0) { itemMap[itemIndex] = {key, category, count: player.inventory[category][key]}; itemIndex++; } } } else { for (const key of player.inventory[category]) { const details = getItemDetails(key); if (details && details.price > 0) { itemMap[itemIndex] = {key, category, count: 1}; itemIndex++; } } } } 
    
    if (itemIndex > 0) {
        sellableHtml += `<div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2">`;
        for (let i = 0; i < itemIndex; i++) { 
            const item = itemMap[i]; 
            const details = getItemDetails(item.key); 
            const sellPrice = Math.floor(details.price / 2); 
            const countStr = item.category === 'items' ? `(x${item.count})` : ''; 
            sellableHtml += `<div class="flex justify-between items-center p-2 bg-slate-800 rounded"><span>${details.name} ${countStr}</span><div><span class="text-yellow-400 font-semibold mr-4">${sellPrice} G</span><button onclick="sellItem(${i})" class="btn btn-primary text-sm py-1 px-3">Sell</button></div></div>`; 
        } 
        sellableHtml += `</div>`;
    } else {
        sellableHtml = `<p class="text-center text-gray-400">You have nothing to sell.</p>`; 
    }
    
    let html = `<div class="w-full"><h2 class="font-medieval text-3xl mb-4 text-center">Sell Items</h2><div class="h-80 overflow-y-auto inventory-scrollbar pr-2">${sellableHtml}</div><div class="flex justify-center mt-4"><button onclick="renderShop('store')" class="btn btn-primary">Back to Shop</button></div></div>`;
    const container = document.createElement('div');
    container.innerHTML = html;
    render(container);
    window.sellItem = (index) => { const item = itemMap[index]; const details = getItemDetails(item.key); const sellPrice = Math.floor(details.price / 2); player.gold += sellPrice; if (item.category === 'items') { player.inventory.items[item.key]--; if (player.inventory.items[item.key] === 0) delete player.inventory.items[item.key]; } else { player.inventory[item.category] = player.inventory[item.category].filter(k => k !== item.key); } addToLog(`You sold a ${details.name} for ${sellPrice} G.`, 'text-yellow-400'); updateStatsView(); renderSell(); }; 
}
function renderInventory() { 
    gameState.currentView = 'inventory'; 
    const renderList = (category, title) => { 
        const list = category === 'items' ? Object.keys(player.inventory.items) : player.inventory[category]; 
        if (!list || list.length === 0) return ''; 
        let html = `<h3 class="font-medieval text-xl mt-4 mb-2 text-yellow-300">${title}</h3><div class="space-y-2">`; 
        html += list.map(key => { 
            const details = getItemDetails(key); 
            let countStr = '';
            if (category === 'items') {
                countStr = `(x${player.inventory.items[key]})`;
            } else if (category === 'lures' && details.uses) {
                const currentUses = player.inventory.lureUses[key] || 0;
                countStr = `<span class="text-xs text-gray-400 ml-2">(${currentUses}/${details.uses} uses)</span>`;
            }

            const isEquipped = (category === 'weapons' && WEAPONS[key] === player.equippedWeapon) || 
                             (category === 'armor' && ARMOR[key] === player.equippedArmor) ||
                             (category === 'shields' && SHIELDS[key] === player.equippedShield) ||
                             (category === 'lures' && LURES[key] === player.equippedLure); 
            const equippedText = isEquipped ? '<span class="text-green-400 font-bold ml-2">[Equipped]</span>' : ''; 
            let buttonHtml = ''; 
            if (category === 'items' && details.type !== 'junk') { buttonHtml = `<button onclick="useItem('${key}')" class="btn btn-item text-sm py-1 px-3">Use</button>`; } 
            else if (category !== 'items' && !isEquipped) { buttonHtml = `<button onclick="equipItem('${key}')" class="btn btn-primary text-sm py-1 px-3">Equip</button>`; } 
            return `<div class="flex justify-between items-center p-2 bg-slate-800 rounded"><span>${details.name} ${countStr} ${equippedText}</span>${buttonHtml}</div>`; }).join(''); 
            html += `</div>`; 
            return html; 
    }; 
    const renderSpellbook = () => { let html = `<h3 class="font-medieval text-xl mt-4 mb-2 text-purple-300">Spellbook</h3><div class="space-y-2">`; if (player.spells.length === 0) { html += `<p class="text-gray-400">You have not learned any spells.</p>`; } else { html += player.spells.map(key => { const details = MAGIC[key]; return `<div class="p-2 bg-slate-800 rounded"><div class="flex justify-between items-center"><span class="font-bold text-purple-200">${details.name}</span><span class="text-blue-400">${details.cost} MP</span></div><p class="text-sm text-gray-400 mt-1">${details.description}</p></div>`; }).join(''); } html += `</div>`; return html; }; 
    let html = `
        <div class="w-full text-left">
            <h2 class="font-medieval text-3xl mb-4 text-center">Inventory & Spells</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 h-80">
                <div class="h-full overflow-y-auto inventory-scrollbar pr-2">
                    ${renderSpellbook()}
                </div>
                <div class="h-full overflow-y-auto inventory-scrollbar pr-2">
                    ${renderList('items', 'Items')}
                    ${renderList('weapons', 'Weapons')}
                    ${renderList('armor', 'Armor')}
                    ${renderList('shields', 'Shields')}
                    ${renderList('lures', 'Lures')}
                </div>
            </div>
            <div class="text-center mt-4">
                <button onclick="returnFromInventory()" class="btn btn-primary">Back</button>
            </div>
        </div>`;
    const container = document.createElement('div');
    container.innerHTML = html;
    render(container);
}
function useItem(itemKey, inBattle = false) { const details = ITEMS[itemKey]; if (details.type === 'healing') { player.hp = Math.min(player.maxHp, player.hp + details.amount); } else if (details.type === 'mana_restore') { player.mp = Math.min(player.maxMp, player.mp + details.amount); } player.inventory.items[itemKey]--; if (player.inventory.items[itemKey] === 0) delete player.inventory.items[itemKey]; addToLog(`You used a <span class="font-bold text-green-300">${details.name}</span>.`); updateStatsView(); if (!inBattle) renderInventory(); }
function equipItem(itemKey) { 
    if (itemKey in WEAPONS) player.equippedWeapon = WEAPONS[itemKey]; 
    if (itemKey in ARMOR) player.equippedArmor = ARMOR[itemKey]; 
    if (itemKey in SHIELDS) player.equippedShield = SHIELDS[itemKey]; 
    if (itemKey in LURES) player.equippedLure = LURES[itemKey];
    addToLog(`You equipped the <span class="font-bold text-cyan-300">${getItemDetails(itemKey).name}</span>.`); 
    updateStatsView(); 
    renderInventory(); 
}

// --- BATTLE FUNCTIONS ---
function startBattle() { 
    gameState.isPlayerTurn = true; 
    generateEnemy(); 
    lastViewBeforeInventory = 'battle';
    gameState.currentView = 'battle'; 
    addToLog(`A wild <span class="font-bold text-red-400">${currentEnemy.name}</span> appears!`); 
    renderBattle(); 
}

function renderBattle(subView = 'main') {
     if (!currentEnemy || !currentEnemy.isAlive()) return;
     if (subView === 'main') {
        const template = document.getElementById('template-battle');
        const view = template.content.cloneNode(true);
        view.querySelector('[data-id="enemy-name"]').textContent = currentEnemy.name;
        view.querySelector('[data-id="enemy-hp"]').textContent = `${currentEnemy.hp} / ${currentEnemy.maxHp} HP`;
        render(view);
     } else if (subView === 'magic') {
        let spellsHtml = player.spells.map(key => { const spell = MAGIC[key]; const canCast = player.mp >= spell.cost; return `<button onclick="castSpell('${key}')" class="btn btn-magic w-full text-left" ${!canCast ? 'disabled' : ''}><div class="flex justify-between"><span>${spell.name}</span><span>${spell.cost} MP</span></div></button>`; }).join('');
        let html = `<h2 class="font-medieval text-3xl mb-4 text-center">Cast a Spell</h2><div class="grid grid-cols-2 gap-2 mb-4">${spellsHtml}</div><button onclick="renderBattle('main')" class="btn btn-primary">Back</button>`;
        const container = document.createElement('div');
        container.innerHTML = html;
        render(container);
     } else if (subView === 'item') {
        let itemsHtml = Object.keys(player.inventory.items).filter(key => ITEMS[key].type !== 'junk').map(key => { const item = ITEMS[key]; const count = player.inventory.items[key]; return `<button onclick="useItemInBattle('${key}')" class="btn btn-item w-full text-left"><div class="flex justify-between"><span>${item.name}</span><span>x${count}</span></div></button>`; }).join('');
        if (!itemsHtml) { itemsHtml = `<p class="text-gray-400 text-center col-span-2">You have no usable items.</p>`; }
        let html = `<h2 class="font-medieval text-3xl mb-4 text-center">Use an Item</h2><div class="grid grid-cols-2 gap-2 mb-4">${itemsHtml}</div><button onclick="renderBattle('main')" class="btn btn-primary">Back</button>`;
        const container = document.createElement('div');
        container.innerHTML = html;
        render(container);
     }
}
function castSpell(spellKey) {
    gameState.isPlayerTurn = false; const spell = MAGIC[spellKey]; player.mp -= spell.cost; updateStatsView();
    addToLog(`You cast ${spell.name}!`, 'text-purple-300');
    switch(spell.type) {
        case 'damage': const magicDamage = rollDice(...spell.damage) + player.intelligence; currentEnemy.takeDamage(magicDamage); addToLog(`It deals <span class="font-bold text-purple-400">${magicDamage}</span> damage.`); break;
        case 'healing': const healAmount = rollDice(...spell.healing) + player.intelligence; player.hp = Math.min(player.maxHp, player.hp + healAmount); addToLog(`You recover <span class="font-bold text-green-400">${healAmount}</span> HP.`); updateStatsView(); break;
    }
    checkBattleStatus();
}
function useItemInBattle(itemKey) { gameState.isPlayerTurn = false; useItem(itemKey, true); checkBattleStatus(); }
function battleAction(type) {
    if (!gameState.isPlayerTurn) return;
    $('#battle-actions')?.classList.add('hidden');
    switch (type) {
        case 'attack':
            gameState.isPlayerTurn = false; const weapon = player.equippedWeapon; const damage = rollDice(...weapon.damage) + player.strength; currentEnemy.takeDamage(damage);
            addToLog(`You attack with ${weapon.name}, dealing <span class="font-bold text-yellow-300">${damage}</span> physical damage.`);
            if (weapon.effect) {
                if (weapon.effect.type === 'fire_damage') { const fireDamage = rollDice(...weapon.effect.damage); currentEnemy.takeDamage(fireDamage); addToLog(`The blade burns for an extra <span class="font-bold text-orange-400">${fireDamage}</span> fire damage.`); }
                if (weapon.effect.type === 'lifesteal') { const healedAmount = Math.floor(damage * weapon.effect.amount); if (healedAmount > 0) { player.hp = Math.min(player.maxHp, player.hp + healedAmount); addToLog(`You drain <span class="font-bold text-green-400">${healedAmount}</span> HP from the attack.`); updateStatsView(); } }
            }
            checkBattleStatus(); break;
        case 'magic': renderBattle('magic'); break;
        case 'item': renderBattle('item'); break;
        case 'flee':
            gameState.isPlayerTurn = false;
            if (Math.random() > 0.3) { addToLog(`You successfully escaped!`, 'text-green-400'); setTimeout(renderMainMenu, 1500); }
            else { addToLog(`You failed to escape!`, 'text-red-400'); enemyTurn(); }
            break;
    }
}
function checkBattleStatus() {
    if (!currentEnemy.isAlive()) {
        if (player.activeQuest) { const quest = QUESTS[player.activeQuest]; if (quest.type === 'extermination' && quest.target === currentEnemy.speciesData.name.toLowerCase().replace(/ /g, '_')) { player.questProgress++; addToLog(`Quest progress: ${player.questProgress}/${quest.required}`, 'text-amber-300'); updateStatsView(); } }
        addToLog(`You have defeated the ${currentEnemy.name}!`, 'text-green-400 font-bold');
        player.gainXp(currentEnemy.xpReward); player.gold += currentEnemy.goldReward;
        addToLog(`You found <span class="font-bold">${currentEnemy.goldReward}</span> G.`, 'text-yellow-400');
        for (const item in currentEnemy.lootTable) { if (Math.random() < (currentEnemy.lootTable[item] * currentEnemy.lootChanceMod)) { player.addToInventory(item); } }
        updateStatsView(); setTimeout(renderMainMenu, 3000);
    } else {
        setTimeout(enemyTurn, 400);
    }
}
function handleEndOfTurnEffects() { if (player.equippedArmor.effect) { if (player.equippedArmor.effect.type === 'mp_regen') { const manaGained = player.equippedArmor.effect.amount; if (player.mp < player.maxMp) { player.mp = Math.min(player.maxMp, player.mp + manaGained); addToLog(`Your robes hum, restoring <span class="font-bold text-blue-400">${manaGained}</span> MP.`, 'text-blue-300'); updateStatsView(); } } } }
function enemyTurn() {
    if (!currentEnemy.isAlive()) return; handleEndOfTurnEffects();
    setTimeout(() => {
        currentEnemy.attack(player);
        if (!player.isAlive()) {
            const template = document.getElementById('template-death');
            render(template.content.cloneNode(true));
            addToLog(`You were defeated by the ${currentEnemy.name}...`, 'text-red-600 font-bold'); 
            localStorage.removeItem('rpgSaveData');
            setTimeout(() => { 
                $('#game-container').classList.add('hidden'); 
                $('#start-screen').classList.remove('hidden'); 
                $('#player-name-input').value = ''; 
                logElement.innerHTML = ''; 
            }, 3000);
        } else { 
            $('#battle-actions')?.classList.remove('hidden'); 
            gameState.isPlayerTurn = true; 
        }
    }, 400);
}
function saveGame(manual = false) { if (!player) return; try { const saveData = JSON.stringify(player); localStorage.setItem('rpgSaveData', saveData); if (manual) { addToLog('Game Saved!', 'text-green-400 font-bold'); } } catch (error) { console.error("Could not save game:", error); } }
function loadGame() { const savedData = localStorage.getItem('rpgSaveData'); if (savedData) { try { const parsedData = JSON.parse(savedData); player = new Player(parsedData.name); Object.assign(player, parsedData); $('#start-screen').classList.add('hidden'); $('#game-container').classList.remove('hidden'); addToLog(`Welcome back, ${player.name}!`); updateStatsView(); renderMainMenu(); } catch (error) { console.error("Could not load game:", error); localStorage.removeItem('rpgSaveData'); } } }
function initGame(playerName) { $('#start-screen').classList.add('hidden'); $('#game-container').classList.remove('hidden'); player = new Player(playerName); addToLog(`Welcome, ${playerName}! Your adventure begins.`); updateStatsView(); renderMainMenu(); }
$('#start-game-btn').addEventListener('click', () => { const name = $('#player-name-input').value.trim(); if (name) { initGame(name); } else { $('#player-name-input').classList.add('border-red-500'); } });
$('#player-name-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') $('#start-game-btn').click(); });
window.addEventListener('load', () => { 
    $('#load-game-btn').addEventListener('click', loadGame); 
    if (localStorage.getItem('rpgSaveData')) { 
        $('#load-game-btn').classList.remove('hidden'); 
    } 
});
</script>

</body>
</html>

